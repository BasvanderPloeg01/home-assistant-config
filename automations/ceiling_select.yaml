# Manually select a LIFX cloud effect for the ceiling washlights.
- id: ceiling_select
  alias: Select Ceiling Washlight Effect
  trigger:
    - platform: state
      entity_id: input_select.ceiling_effect

  condition:
    # If no other process is handling the ceiling washlights.
    - condition: state
      entity_id: input_boolean.ceiling_semaphore
      state: 'off'

    # If an actual effect is selected.
    - condition: template
      value_template: "{% if not is_state('input_select.ceiling_effect', 'Auto') %}true{% endif %}"

  action:
    # Reserve the ceiling washlights.
    - service: input_boolean.turn_on
      entity_id: input_boolean.ceiling_semaphore

    # Override any ceiling washlight effect.
    - service: input_boolean.turn_on
      entity_id: input_boolean.ceiling_effect_override

    # Send the effect update via Mosquitto.
    - service: mqtt.publish
      data_template:
        topic: 'home/ceiling/effect'
        payload: >-
          {% set effects = {
            'Blissful':         'e1cd000b-2780-40e9-8ae5-2ca55b67b01d',
            'Celebrations':     '9428fffc-8466-489e-b93a-c7f062c45a81',
            'Cheerful':         '2223a575-b13d-468f-875c-1d8275b2f718',
            'Daylight':         '40d6b6a6-0eb7-48bc-81c1-b469e91a9b6d',
            'Focusing':         '83bfebf8-ab73-483f-9987-5c6a8a340609',
            'Intense':          'd8a58aca-0e9a-4379-8668-363e237316b2',
            'Mellow':           '4cc1d4fe-cf9e-4391-899b-0bb5f13f4c73',
            'Movie':            'ba3ac9bf-ae54-4e11-a8a8-d7ec6862293d',
            'Northern Lights':  '7e85572c-facc-46d9-a3fa-832ed82a9496',
            'Powerful':         'afed3ed6-c918-44d5-9207-7e895c6d3d0f',
            'Relaxing':         'c4d42b21-8d79-4637-a04a-0ace24824c30',
            'Serene':           '66d389bc-fd2a-460d-9d70-3063db2ea509',
            'Soothing':         'a09a3137-98f1-41a8-b9ae-64a1cec54c1a',
            'Tranquil':         '34cacbbe-d4ad-4abf-b108-6973431d63d3',
            'Warming':          '8b85e701-0189-4c4b-a703-cfa3d0f0ab64',
          } %}
          {% set selected = states('input_select.ceiling_effect') %}

          {% if effects[selected] %}
            {
              "name": "{{ selected }}",
              "uuid": "{{ effects[selected] }}"
            }
          {% endif %}

    # Release the ceiling washlights.
    - service: input_boolean.turn_off
      entity_id: input_boolean.ceiling_semaphore


# Return the ceiling washlights to the default scheduled effect.
- id: ceiling_washlight_default
  alias: Default Ceiling Washlight Effect
  trigger:
    - platform: state
      entity_id: input_select.ceiling_effect
      to: Auto

  action:
    # Remove the effect override.
    - service: input_boolean.turn_off
      entity_id: input_boolean.ceiling_effect_override
