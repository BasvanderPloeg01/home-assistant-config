#
# Warn someone if humidity levels may lead to mold issues
#
# Only triggers if windows and doors are open, because we're not responsible
# for what's happening outside.
#
# @subscribe input_boolean.doors_open
# @subscribe input_boolean.windows_open
#
# @see /automations/check_humidity.yaml
#
- id: check_mold_conditions
  alias: Check mold conditions
  trigger:
    # Mold grows above 55% relative humidity, and thrives above 70%.
    - platform: numeric_state
      entity_id: sensor.average_humidity
      above: 60

  condition:
    # Doors have been closed for a while.
    - condition: state
      entity_id: input_boolean.doors_open
      state: 'off'
      for:
        minutes: 60

    # Windows have been closed for a while.
    - condition: state
      entity_id: input_boolean.doors_open
      state: 'off'
      for:
        minutes: 60

  action:
    # Warn someone to take action (like empty the dehumidifier's collection
    # bucket).
    - service: notify.group
      data:
        title: "Home humidity is way too high"
        message: |
          {{ states('sensor.average_humidity') }}% = Risk of mold!
          Check the dehumidifier.

    # Pin a warning message in the frontend.
    - service: persistent_notification.create
      data:
        notification_id: mold
        title: "Risk of mold!"
        message: |
          Humidity is way too high: {{ states('sensor.average_humidity') }}%<br>
          Check the dehumidifier.
